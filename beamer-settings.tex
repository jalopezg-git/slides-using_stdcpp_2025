%\usetheme{Pittsburgh}
%\usecolortheme{seahorse}
\usetheme{metropolis}
\metroset{sectionpage=progressbar} % or none
\metroset{numbering=counter} % or none, fraction
\metroset{progressbar=frametitle}
\setbeamercovered{transparent}

% Header and footer
\beamertemplatenavigationsymbolsempty
%\makeatletter
\setbeamertemplate{footline}
{
  \leavevmode%
  \hbox{%
  \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,center]{author in head/foot}%
    \usebeamerfont{author in head/foot}\insertshorttitle{}
  \end{beamercolorbox}%
  \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,center]{title in head/foot}%
    \usebeamerfont{title in head/foot}\insertshortdate{}
  \end{beamercolorbox}%
  \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,right]{date in head/foot}%
    \usebeamerfont{date in head/foot}
    \insertframenumber{} / \inserttotalframenumber\hspace*{2ex}
  \end{beamercolorbox}}%
  \vskip0pt%
}
\makeatother
\setbeamerfont{footnote mark}{size=\tiny}
\setbeamerfont{footnote}{size=\tiny}

\newlength{\spaceheight}
\setlength{\spaceheight}{\textheight}
\addtolength{\spaceheight}{-\headheight}
\addtolength{\spaceheight}{-\headsep}

% Wide pages for large photos
\newcommand\Wider[2][3em]{%
\makebox[\linewidth][c]{%
  \begin{minipage}{\dimexpr\textwidth+#1\relax}
  \raggedright#2
  \end{minipage}%
  }%
}


% Colors and fonts
\definecolor{beamerbackgroundcolor}{RGB}{250,250,250}
\definecolor{cerulean}{HTML}{0081a7}
\definecolor{darkcyan}{HTML}{4d908e}
\definecolor{verdigris}{HTML}{00afb9}
\definecolor{myyellow}{RGB}{242,226,149}
\definecolor{invforeground}{HTML}{1ed4e5}
\definecolor{altalert}{HTML}{ae2012}
\definecolor{mygreen}{HTML}{c7f9cc}
\definecolor{myred}{HTML}{f8ad9d}
\setbeamercolor{block title}{fg=black,bg=red!30!black!30}
\setbeamercolor{block body}{fg=black,bg=beamerbackgroundcolor!96!black}
\setbeamercolor{block title alerted}{fg=red,bg=gray!40}
\setbeamercolor{block title example}{fg=black,bg=green!20}
\setbeamercolor{block body example}{fg=black,bg=green!5}
\setbeamercolor{block body alerted}{fg=black,bg=red!5}
\setbeamerfont{block title}{series=\bfseries}

\setbeamercolor{title}{fg=white}
\setbeamercolor{author}{fg=white}
\setbeamercolor{date}{fg=white}
\setbeamercolor{frametitle}{bg=cerulean}
\setbeamercolor{section title}{fg=cerulean} % Actually: link color
\setbeamercolor{author in head/foot}{bg=beamerbackgroundcolor, fg=cerulean}
\setbeamercolor{title in head/foot}{bg=beamerbackgroundcolor, fg=cerulean}
\setbeamercolor{date in head/foot}{bg=beamerbackgroundcolor, fg=cerulean}


% Backup slides
\newcommand{\beginbackup}{
   \newcounter{framenumbervorappendix}
   \setcounter{framenumbervorappendix}{\value{framenumber}}
}
\newcommand{\backupend}{
   \addtocounter{framenumbervorappendix}{-\value{framenumber}}
   \addtocounter{framenumber}{\value{framenumbervorappendix}}
}


% Framed blocks
\makeatletter
\newcommand\beamerboxesframed[2][]{%
  \global\let\beamer@firstlineitemizeunskip=\relax%
  \vbox\bgroup%
  \setkeys{beamerboxes}{upper=block title,lower=block body,width=\textwidth}%
  \setkeys{beamerboxes}{#1}%
  {%
    \usebeamercolor{\bmb@lower}%
    \globalcolorstrue%
    \colorlet{lower.bg}{bg}%
  }%
  {%
    \usebeamercolor{\bmb@upper}%
    \globalcolorstrue%
    \colorlet{upper.bg}{bg}%
  }%
  %
  % Typeset head
  %
  \vskip4bp
  \setbox\bmb@box=\hbox{%
    \begin{minipage}[b]{\bmb@width}%
      \usebeamercolor[fg]{\bmb@upper}%
      #2%
    \end{minipage}}%
  \ifdim\wd\bmb@box=0pt%
    \setbox\bmb@box=\hbox{}%
    \ht\bmb@box=0pt%
    \bmb@prevheight=-4.5pt%
  \else%
    \wd\bmb@box=\bmb@width%
    \bmb@temp=\dp\bmb@box%
    \ifdim\bmb@temp<1.5pt%
      \bmb@temp=1.5pt%
    \fi%
    \setbox\bmb@box=\hbox{\raise\bmb@temp\hbox{\box\bmb@box}}%
    \dp\bmb@box=0pt%
    \bmb@prevheight=\ht\bmb@box%
  \fi%
  \bmb@temp=\bmb@width%
  \bmb@dima=\bmb@temp\advance\bmb@dima by2.2bp%
  \bmb@dimb=\bmb@temp\advance\bmb@dimb by4bp%
  \hbox{%
    \begin{pgfpicture}{0bp}{+-\ht\bmb@box}{0bp}{+-\ht\bmb@box}
      \ifdim\wd\bmb@box=0pt%
        \color{lower.bg}%
      \else%
        \color{upper.bg}%
      \fi%
      \pgfpathqmoveto{-4bp}{-1bp}
      \pgfpathqcurveto{-4bp}{1.2bp}{-2.2bp}{3bp}{0bp}{3bp}
      \pgfpathlineto{\pgfpoint{\bmb@temp}{3bp}}
      \pgfpathcurveto%
      {\pgfpoint{\bmb@dima}{3bp}}%
      {\pgfpoint{\bmb@dimb}{1.2bp}}%
      {\pgfpoint{\bmb@dimb}{-1bp}}%
      \bmb@dima=-\ht\bmb@box%
      \advance\bmb@dima by-2pt%
      \pgfpathlineto{\pgfpoint{\bmb@dimb}{\bmb@dima}}
      \pgfpathlineto{\pgfpoint{-4bp}{\bmb@dima}}
      \pgfpathclose
      \pgfsetstrokecolor{black}\pgfusepath{stroke, fill}
    \end{pgfpicture}%
    \copy\bmb@box%
  }%
  \nointerlineskip%
  \ifdim\wd\bmb@box=0pt
  \else
    \vskip2.4pt%
  \fi%
  \nointerlineskip%
  \setbox\bmb@colorbox=\hbox{{\pgfpicturetrue\pgfsetcolor{lower.bg}}}%
  \setbox\bmb@box=\hbox\bgroup\begin{minipage}[b]{\bmb@width}%
    \vskip2pt%
    \usebeamercolor[fg]{\bmb@lower}%
    \colorlet{beamerstructure}{upper.bg}%
    \colorlet{structure}{upper.bg}%
    %\color{.}%
}
\def\endbeamerboxesframed{%
  \end{minipage}\egroup%
  \wd\bmb@box=\bmb@width%
  \bmb@temp=\dp\bmb@box%
  \advance\bmb@temp by.5pt%
  \setbox\bmb@box=\hbox{\raise\bmb@temp\hbox{\box\bmb@box}}%
  \dp\bmb@box=0pt%
  \bmb@temp=\wd\bmb@box%
  \bmb@dima=\bmb@temp\advance\bmb@dima by2.2bp%
  \bmb@dimb=\bmb@temp\advance\bmb@dimb by4bp%
  \hbox{%
    \begin{pgfpicture}{0bp}{0bp}{0bp}{0bp}
      \unhbox\bmb@colorbox%
      \pgfpathmoveto{\pgfpoint{-4bp}{\ht\bmb@box}}
      \pgfpathlineto{\pgfpoint{-4bp}{1bp}}
      \pgfpathqcurveto{-4bp}{-1.2bp}{-2.2bp}{-3bp}{0bp}{-3bp}
      \pgfpathlineto{\pgfpoint{\the\bmb@temp}{-3bp}}
      \pgfpathcurveto%
      {\pgfpoint{\the\bmb@dima}{-3bp}}%
      {\pgfpoint{\the\bmb@dimb}{-1.2bp}}%
      {\pgfpoint{\the\bmb@dimb}{1bp}}%
      {
      \bmb@dima=\ht\bmb@box%
      \pgfpathlineto{\pgfpoint{\bmb@dimb}{\bmb@dima}}
      \pgfsetstrokecolor{black}\pgfusepath{stroke, fill}
      }
    \end{pgfpicture}%
    \box\bmb@box%
  }%
  \vskip2bp%
  \egroup% of \vbox\bgroup
}
\makeatother
\defbeamertemplateparent{blocks}[framed]{block begin,block end,%
  block alerted begin,block alerted end,%
  block example begin,block example end}[1][]
{[#1]}

\defbeamertemplate{block begin}{framed}[1][]
{
  \par\vskip\medskipamount%
  \begin{beamerboxesframed}[upper=block title,lower=block body,#1]%
    {\raggedright\usebeamerfont*{block title}\insertblocktitle}%
    \raggedright%
    \usebeamerfont{block body}%
}
\defbeamertemplate{block end}{framed}[1][]
{\end{beamerboxesframed}\vskip\smallskipamount}

\defbeamertemplate{block alerted begin}{framed}[1][]
{
  \par\vskip\medskipamount%
  \begin{beamerboxesframed}[upper=block title alerted,lower=block body alerted,#1]%
    {\raggedright\usebeamerfont*{block title alerted}\insertblocktitle}%
    \raggedright%
    \usebeamerfont{block body alerted}%
}%
\defbeamertemplate{block alerted end}{framed}[1][]
{\end{beamerboxesframed}\vskip\smallskipamount}

\defbeamertemplate{block example begin}{framed}[1][]
{
  \par\vskip\medskipamount%
  \begin{beamerboxesframed}[upper=block title example,lower=block body example,#1]
    {\raggedright\usebeamerfont*{block title example}\insertblocktitle}%
    \raggedright%
    \usebeamerfont{block body alerted}%
}%
\defbeamertemplate{block example end}{framed}[1][]
{\end{beamerboxesframed}\vskip\smallskipamount}

\setbeamertemplate{blocks}[framed]
% Use for normal blocks: \setbeamertemplate{blocks}[rounded][shadow=true]

\newenvironment<>{varblock}[2][\textwidth]{%
   \setlength{\textwidth}{#1}
   \begin{actionenv}#3%
     \def\insertblocktitle{#2}%
     \par%
     \usebeamertemplate{block begin}}
   {\par%
     \usebeamertemplate{block end}%
   \end{actionenv}}

\addtobeamertemplate{frametitle}{}{
\addvspace{-0.95cm}
\hfill
}

\setbeamercolor{section title}{fg=red}
\setbeamertemplate{blocks}[rounded][shadow=true]
\def\duration#1{\hfill[#1]}

\makeatletter
\let\@@TOC=\tableofcontents
\def\tableofcontents[#1]{\bgroup\parskip=0pt\@@TOC[#1]\egroup}
\makeatother

\AtBeginDocument{
  \setbeamertemplate{section in toc}[square]
  \setbeamertemplate{subsection in toc}{\hspace{1.3em}\rule[0.3ex]{4pt}{4pt}~\inserttocsubsection\par}
  \setbeamertemplate{itemize items}{\raisebox{.5ex}{\rule{.5ex}{.5ex}}}
  \setbeamercolor{alerted text}{fg=altalert}
}

\def\maketitle{%
    {\setbeamertemplate{background canvas}{%
                                   \tikz[remember picture,overlay]\node[fit=(current page),top color=verdigris,bottom color=cerulean,shading angle=45]{};}
    \setbeamercolor{alerted text}{fg=invforeground}
    \begin{frame}[plain,noframenumbering,label=titlepage]
        \centering
        \vspace{-1.5cm}\titlepage
    \end{frame}}}
\def\makeendpage{%
    {\setbeamertemplate{background canvas}{%
                                   \tikz[remember picture,overlay]\node[fit=(current page),top color=verdigris,bottom color=cerulean,shading angle=45]{};}
    \setbeamercolor{alerted text}{fg=invforeground}
    \setbeamercolor*{enumerate item}{fg=white}
    \begin{frame}[plain,noframenumbering,label=titlepage]
        \centering
        \vfill
        \tikz{
            \path node[opacity=.1] {}
                node[font={\fontsize{24}{24}\selectfont},white] {Thank you!};
        }
        \vfill
        %
        \ifthenelse{\isundefined{\thisPresentationURL}}{}{%
                \begin{center}
                \tikz\node[fill=white]{\qrcode[height=1in]{\thisPresentationURL}};\\[1ex]
                \textcolor{white}{\itshape\small [Link to slides used in this presentation]}
                \end{center}%
        }
        %
        \ifthenelse{\isundefined{\endpageFootnote}}{}{%
                {\color{white}\footnotesize\rule{6em}{.1pt}\\
                                \endpageFootnote}
        }
    \end{frame}}}

%\setsansfont[BoldFont=Fira Sans Regular,ItalicFont=Fira Sans Light Italic,Ligatures=NoCommon]{Fira Sans Light}
%\setmathfont{FiraSans-ThinItalic.ttf}

\def\linkbox#1#2{%
    \raisebox{-.5ex}{\tikz{\node[font=\footnotesize,myyellow!70!black!80,draw,rounded corners,fill=myyellow!70!white!20]{\blacktriangleright~\href{#1}{#2}};}}
}

\def\overlaynote#1{%
    \tikz[remember picture,overlay]{\node[fill=black!5,draw,rounded corners,text width=\textwidth,blur shadow] at (current page) {#1\vspace{1ex}};}
}
